<?php

namespace ConventionalChangelog;

$releaseMessagePrefix = 'chore(release): ';

return [
    'types' => ['feat', 'fix', 'perf', 'docs', 'chore'],
    // Ignore changelogs
    'ignorePatterns' => [
        '/chore\(changelog\)[:].*/i',
    ],
    'releaseCommitMessageFormat' => "{$releaseMessagePrefix}{{currentTag}}",
    'postRun' => function () use ($releaseMessagePrefix) {
        require_once __DIR__ . '/autoload.php';
        $lastTag = Git\Repository::getLastTag();
        $lastTagCommit = Git\Repository::getLastTagCommit();
        $lastCommit = Git\Repository::getLastCommit();

        if ($lastTagCommit !== $lastCommit) {
            return;
        }

        $binFile = __DIR__ . '/conventional-changelog';
        $readmeFile = __DIR__ . '/README.md';
        $semverRegex = Helper\SemanticVersion::PATTERN;

        // Get version
        $version = new Helper\SemanticVersion($lastTag);

        // Update version on readme
        $readme = file_get_contents($readmeFile);
        $readme = preg_replace("/(https:\/\/img\.shields\.io\/badge\/version)-({$semverRegex})-/m", '$1-' . $version->getVersion() . '-', $readme);
        file_put_contents($readmeFile, $readme);

        // Update version on bin
        $bin = file_get_contents($binFile);
        $bin = preg_replace("/(\('conventional-changelog', )'({$semverRegex})'/m", '$1\'' . $version->getVersion() . '\'', $bin);
        file_put_contents($binFile, $bin);

        // Delete tag
        Git\Repository::deleteTag($lastTag);

        // Commit and tag
        $message = $releaseMessagePrefix . $version->getVersion();
        Git\Repository::commit($message, [$binFile, $readmeFile], true, true, true);
        Git\Repository::tag($lastTag);
    },
];
